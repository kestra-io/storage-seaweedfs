volumes:
  kestra-data:
    driver: local
  seaweedfs-data:
    driver: local

services:
  # SeaweedFS Master Server
  seaweedfs-master:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-master
    command: "master -ip=seaweedfs-master -ip.bind=0.0.0.0"
    ports:
      - "9333:9333"
      - "19333:19333"
    volumes:
      - seaweedfs-data:/data
    networks:
      - kestra
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9333/cluster/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # SeaweedFS Volume Server
  seaweedfs-volume:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-volume
    command: "volume -mserver=seaweedfs-master:9333 -ip.bind=0.0.0.0 -port=8080"
    ports:
      - "8081:8080"
      - "18080:18080"
    depends_on:
      seaweedfs-master:
        condition: service_healthy
    networks:
      - kestra

  # SeaweedFS Filer Server
  seaweedfs-filer:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-filer
    command: "filer -master=seaweedfs-master:9333 -ip.bind=0.0.0.0"
    ports:
      - "8888:8888"
      - "18888:18888"
    depends_on:
      seaweedfs-master:
        condition: service_healthy
      seaweedfs-volume:
        condition: service_started
    networks:
      - kestra
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8888/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Kestra Server
  kestra:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kestra-server
    stop_grace_period: 6m
    user: "root"
    command: server standalone
    ports:
      - "8080:8080"
      - "8085:8081"
    volumes:
      - kestra-data:/app/storage
      - ./build/libs/storage-seaweedfs-1.1.0-SNAPSHOT.jar:/app/plugins/storage-seaweedfs-1.1.0-SNAPSHOT.jar:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/kestra-wd:/tmp/kestra-wd
    environment:
      KESTRA_CONFIGURATION: |
        kestra:
          server:
            basic-auth:
              enabled: false
          repository:
            type: memory
          storage:
            type: seaweedfs
            seaweedfs:
              filer-host: seaweedfs-filer
              filer-port: 18888
              prefix: "kestra/"
              replication: "000"
          queue:
            type: memory
          tasks:
            tmp-dir:
              path: /tmp/kestra-wd/tmp
          url: http://localhost:8080/
    depends_on:
      seaweedfs-filer:
        condition: service_healthy
    networks:
      - kestra

networks:
  kestra:
    driver: bridge
